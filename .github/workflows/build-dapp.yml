name: Build dApp Store

on:
  push:
    branches: [main]
    tags:
      - 'v*-dapp'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release with APK'
        required: false
        default: false
        type: boolean

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build-dapp:
    name: Build dApp APK
    runs-on: ubuntu-latest
    outputs:
      build_id: ${{ steps.build.outputs.build_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn test --watchAll=false

      - name: Build dApp APK
        id: build
        run: |
          BUILD_OUTPUT=$(eas build --platform android --profile dapp-store --non-interactive --json)
          BUILD_ID=$(echo $BUILD_OUTPUT | jq -r '.[0].id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Build ID: $BUILD_ID"

      - name: Download APK artifact
        if: github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/')
        run: |
          eas build:download --id ${{ steps.build.outputs.build_id }} --path ./asdf-dapp.apk

      - name: Upload APK artifact
        if: github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: asdf-dapp-apk
          path: ./asdf-dapp.apk
          retention-days: 30

  prepare-dapp-store:
    name: Prepare dApp Store Submission
    needs: build-dapp
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Metaplex Sugar CLI
        run: |
          bash <(curl -sSf https://sugar.metaplex.com/install.sh)

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: asdf-dapp-apk
          path: ./dist

      - name: Generate dApp Store metadata
        run: |
          mkdir -p ./dapp-store

          # Create release NFT metadata
          cat > ./dapp-store/release.json << EOF
          {
            "schema_version": "0.2.0",
            "name": "ASDF-Dapp",
            "version": "${GITHUB_REF_NAME#v}",
            "android_package": "com.asdf.mobile",
            "solana_mobile_dapp_publisher_portal": {
              "google_store_package": "com.asdf.mobile",
              "testing_instructions": "Connect with Phantom or Solflare wallet to test all features."
            },
            "release_details": {
              "release_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "git_tag": "${GITHUB_REF_NAME}",
              "commit_sha": "${GITHUB_SHA}"
            }
          }
          EOF

          echo "dApp Store metadata generated"
          cat ./dapp-store/release.json

      - name: Upload dApp Store package
        uses: actions/upload-artifact@v4
        with:
          name: dapp-store-package
          path: |
            ./dist/asdf-dapp.apk
            ./dapp-store/release.json
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build-dapp, prepare-dapp-store]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dapp-store-package
          path: ./release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./release/dist/asdf-dapp.apk
            ./release/dapp-store/release.json
          generate_release_notes: true
          body: |
            ## ASDF-Dapp Release

            ### Installation
            1. Download `asdf-dapp.apk`
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK

            ### dApp Store Submission
            The `release.json` file contains metadata for Solana dApp Store submission.

            ### Verification
            - Build ID: ${{ needs.build-dapp.outputs.build_id }}
            - Commit: ${{ github.sha }}
